var %in% c("a","b","d") ~ "main",
var %in% c("a:b","a:d","b:d") ~ "double",
var %in% c("a:b:d") ~ "triple"
)) %>%
mutate(
var = factor(var,levels = rev(c("a","b","d","a:b","a:d","b:d","a:b:d"))),
var_type = factor(var_type,levels = c("main","double","triple")),
sign_comp = factor(sign_comp,levels = c("up","down"))
) %>%
ggplot() +
aes(x= sign_comp, y= mean_pct, fill= var)+
geom_bar(stat = "identity", position = "stack")+
scale_fill_manual(values = tmp_colors)+
coord_flip()+
facet_grid(sign_comp~var_type,
scales = "free",
switch = "y",
space = "free_y") +
theme_light()
# test diff for each var between up / down
# linear model
tmp_lm = lm(tmp_df$sgnf_pct_expl ~ tmp_df$var*tmp_df$sign_comp, na.action = na.omit )
summary(tmp_lm)
# anova
tmp_aov = aov(tmp_lm)
summary(tmp_aov)
# post hoc Tukey test
library(agricolae)
tmp_comp <- HSD.test(tmp_aov,c("tmp_df$var","tmp_df$sign_comp"),alpha = 0.05,group = T,console = T)
# which OTUs are affected by coal
tmp_df1 = stat_otu_emmeans_fltr %>%
filter(g1 == "C" & pval_adjust <= 0.05) %>%
mutate(
sign_comp = case_when(
# /!\ up = estimates <0
estimate <0 ~ "up",
estimate >0 ~ "down"
)
) %>%
select(OTU,sign_comp) %>%
unique(.)
# which OTUs have signif fval
tmp_df2 <- stat_otu_aov_o %>%
filter(bonferroni <= 0.05) %>%
select(OTU,var,sgnf_pct_expl)
# how many sign_comp by var
tmp_df <- full_join(tmp_df1,tmp_df2,by = "OTU",relationship = "many-to-many") %>%
na.omit(.) %>%
# add taxo
left_join(.,taxtab[,c("OTU","taxa")],by="OTU") %>%
# summarise
dplyr::group_by(taxa,var) %>%
dplyr::summarise(mean_pct = mean(sgnf_pct_expl),
sum_pct = sum(sgnf_pct_expl),
median_pct = median(sgnf_pct_expl),
sd_pct = sd(sgnf_pct_expl)) %>% ungroup() %>%
mutate(var_type = case_when(
var %in% c("a","b","d") ~ "main",
var %in% c("a:b","a:d","b:d") ~ "double",
var %in% c("a:b:d") ~ "triple"
)) %>%
mutate(
var = factor(var,levels = rev(c("a","b","d","a:b","a:d","b:d","a:b:d"))),
var_type = factor(var_type,levels = c("main","double","triple")),
taxa = factor(taxa,levels = rev(levels(reorder(taxtab$taxa,taxtab$order)))))
# add missing taxa
tmp_missing_taxa = as_tibble(matrix(nrow = length(setdiff(unique(taxtab$taxa),unique(tmp_df$taxa))),
ncol = ncol(tmp_df)))
colnames(tmp_missing_taxa) <- colnames(tmp_df)
tmp_missing_taxa$taxa <- setdiff(unique(taxtab$taxa),unique(tmp_df$taxa))
tmp_df <- tmp_df %>% rbind(tmp_missing_taxa) %>% replace_na()
# plot
tmp_colors <- rev(c("#9b2226","#db912b","#005f73","#bb3e03","#ecba53","#0a9396","#94d2bd"))
tmp_df %>%
ggplot() +
aes(x= taxa, y= mean_pct, fill= var)+
geom_bar(stat = "identity", position = "stack")+
scale_fill_manual(values = tmp_colors)+
coord_flip()+
facet_grid(taxa~var_type,
scales = "free",
switch = "y",
space = "free_y") +
theme_light()
# which OTUs are affected by coal
tmp_df1 = stat_otu_emmeans_fltr %>%
filter(g1 == "C" & pval_adjust <= 0.05) %>%
mutate(
sign_comp = case_when(
# /!\ up = estimates <0
estimate <0 ~ "up",
estimate >0 ~ "down"
)
) %>%
select(OTU,sign_comp) %>%
unique(.)
# which OTUs have signif fval
tmp_df2 <- stat_otu_aov_o %>%
filter(bonferroni <= 0.05) %>%
select(OTU,var,sgnf_pct_expl)
# how many sign_comp by var
tmp_df <- full_join(tmp_df1,tmp_df2,by = "OTU",relationship = "many-to-many") %>%
na.omit(.) %>%
# add taxo
left_join(.,taxtab[,c("OTU","taxa")],by="OTU") %>%
# summarise
dplyr::group_by(taxa,var) %>%
dplyr::summarise(mean_pct = mean(sgnf_pct_expl),
sum_pct = sum(sgnf_pct_expl),
median_pct = median(sgnf_pct_expl),
sd_pct = sd(sgnf_pct_expl)) %>% ungroup() %>%
mutate(var_type = case_when(
var %in% c("a","b","d") ~ "main",
var %in% c("a:b","a:d","b:d") ~ "double",
var %in% c("a:b:d") ~ "triple"
)) %>%
mutate(
var = factor(var,levels = rev(c("a","b","d","a:b","a:d","b:d","a:b:d"))),
var_type = factor(var_type,levels = c("main","double","triple")),
taxa = factor(taxa,levels = rev(levels(reorder(taxtab$taxa,taxtab$order)))))
setdiff(taxtab$taxa,tmp_df$taxa)
# how many sign_comp by var
tmp_df <- full_join(tmp_df1,tmp_df2,by = "OTU",relationship = "many-to-many") %>%
na.omit(.) %>%
# add taxo
left_join(.,taxtab[,c("OTU","taxa")],by="OTU")
setdiff(taxtab$taxa,tmp_df$taxa)
# which OTUs are affected by coal
tmp_df1 = stat_otu_emmeans_fltr %>%
filter(g1 == "C" & pval_adjust <= 0.05) %>%
mutate(
sign_comp = case_when(
# /!\ up = estimates <0
estimate <0 ~ "up",
estimate >0 ~ "down"
)
) %>%
select(OTU,sign_comp) %>%
unique(.)
# which OTUs have signif fval
tmp_df2 <- stat_otu_aov_o %>%
filter(bonferroni <= 0.05) %>%
select(OTU,var,sgnf_pct_expl)
# how many sign_comp by var
tmp_df <- full_join(tmp_df1,tmp_df2,by = "OTU",relationship = "many-to-many") %>%
na.omit(.) %>%
# add taxo
left_join(.,taxtab[,c("OTU","taxa")],by="OTU") %>%
# summarise
dplyr::group_by(taxa,var) %>%
dplyr::summarise(mean_pct = mean(sgnf_pct_expl),
sum_pct = sum(sgnf_pct_expl),
median_pct = median(sgnf_pct_expl),
sd_pct = sd(sgnf_pct_expl)) %>% ungroup() %>%
mutate(var_type = case_when(
var %in% c("a","b","d") ~ "main",
var %in% c("a:b","a:d","b:d") ~ "double",
var %in% c("a:b:d") ~ "triple"
)) %>%
mutate(
var = factor(var,levels = rev(c("a","b","d","a:b","a:d","b:d","a:b:d"))),
var_type = factor(var_type,levels = c("main","double","triple")),
taxa = factor(taxa,levels = rev(levels(reorder(taxtab$taxa,taxtab$order)))))
setdiff(taxtab$taxa,tmp_df$taxa)
expand(setdiff(taxtab$taxa,tmp_df$taxa),unique(tmp_df$var))
expand.grid(setdiff(taxtab$taxa,tmp_df$taxa),unique(tmp_df$var))
# add missing taxa
tmp_missing_taxa = as_tibble(matrix(nrow = length(setdiff(unique(taxtab$taxa),unique(tmp_df$taxa))),
ncol = ncol(tmp_df)))
colnames(tmp_missing_taxa) <- colnames(tmp_df)
tmp_missing_taxa$taxa <- setdiff(unique(taxtab$taxa),unique(tmp_df$taxa))
View(tmp_missing_taxa)
# add missing taxa
tmp_missing_taxa <- expand.grid(setdiff(taxtab$taxa,tmp_df$taxa),unique(tmp_df$var)) %>%
rename(taxa = Var1, var = Var2)
# add missing taxa
tmp_missing_taxa <- expand.grid(setdiff(taxtab$taxa,tmp_df$taxa),unique(tmp_df$var)) %>%
rename(taxa = Var1, var = Var2) %>% ungroup()
colnames(tmp_df)
# add missing taxa
tmp_missing_taxa <- expand.grid(setdiff(taxtab$taxa,tmp_df$taxa),unique(tmp_df$var)) %>%
rename(taxa = Var1, var = Var2) %>%
mutate(mean_pct = 0)
# how many sign_comp by var
tmp_df <- full_join(tmp_df1,tmp_df2,by = "OTU",relationship = "many-to-many") %>%
na.omit(.) %>%
# add taxo
left_join(.,taxtab[,c("OTU","taxa")],by="OTU") %>%
# summarise
dplyr::group_by(taxa,var) %>%
dplyr::summarise(mean_pct = mean(sgnf_pct_expl)) %>% ungroup() %>%
mutate(var_type = case_when(
var %in% c("a","b","d") ~ "main",
var %in% c("a:b","a:d","b:d") ~ "double",
var %in% c("a:b:d") ~ "triple"
)) %>%
mutate(
var = factor(var,levels = rev(c("a","b","d","a:b","a:d","b:d","a:b:d"))),
var_type = factor(var_type,levels = c("main","double","triple")),
taxa = factor(taxa,levels = rev(levels(reorder(taxtab$taxa,taxtab$order)))))
# how many sign_comp by var
tmp_df <- full_join(tmp_df1,tmp_df2,by = "OTU",relationship = "many-to-many") %>%
na.omit(.) %>%
# add taxo
left_join(.,taxtab[,c("OTU","taxa")],by="OTU") %>%
# summarise
dplyr::group_by(taxa,var) %>%
dplyr::summarise(mean_pct = mean(sgnf_pct_expl)) %>% ungroup() %>%
mutate(var_type = case_when(
var %in% c("a","b","d") ~ "main",
var %in% c("a:b","a:d","b:d") ~ "double",
var %in% c("a:b:d") ~ "triple"
))
# add missing taxa
tmp_missing_taxa <- expand.grid(setdiff(taxtab$taxa,tmp_df$taxa),unique(tmp_df$var)) %>%
rename(taxa = Var1, var = Var2) %>%
mutate(mean_pct = 0)
# add order and facet variable
tmp_df <- tmp_df %>% rbind(tmp_missing_taxa) %>%
mutate(
var = factor(var,levels = rev(c("a","b","d","a:b","a:d","b:d","a:b:d"))),
var_type = factor(var_type,levels = c("main","double","triple")),
taxa = factor(taxa,levels = rev(levels(reorder(taxtab$taxa,taxtab$order)))))
tmp_df <- tmp_df %>% rbind(tmp_missing_taxa)
# how many sign_comp by var
tmp_df <- full_join(tmp_df1,tmp_df2,by = "OTU",relationship = "many-to-many") %>%
na.omit(.) %>%
# add taxo
left_join(.,taxtab[,c("OTU","taxa")],by="OTU") %>%
# summarise
dplyr::group_by(taxa,var) %>%
dplyr::summarise(mean_pct = mean(sgnf_pct_expl)) %>% ungroup()
# add missing taxa
tmp_missing_taxa <- expand.grid(setdiff(taxtab$taxa,tmp_df$taxa),unique(tmp_df$var)) %>%
rename(taxa = Var1, var = Var2) %>%
mutate(mean_pct = 0)
# add order and facet variable
tmp_df <- tmp_df %>%
rbind(tmp_missing_taxa) %>%
mutate(var_type = case_when(
var %in% c("a","b","d") ~ "main",
var %in% c("a:b","a:d","b:d") ~ "double",
var %in% c("a:b:d") ~ "triple"
)) %>%
mutate(
var = factor(var,levels = rev(c("a","b","d","a:b","a:d","b:d","a:b:d"))),
var_type = factor(var_type,levels = c("main","double","triple")),
taxa = factor(taxa,levels = rev(levels(reorder(taxtab$taxa,taxtab$order)))))
# plot
tmp_colors <- rev(c("#9b2226","#db912b","#005f73","#bb3e03","#ecba53","#0a9396","#94d2bd"))
tmp_df %>%
ggplot() +
aes(x= taxa, y= mean_pct, fill= var)+
geom_bar(stat = "identity", position = "stack")+
scale_fill_manual(values = tmp_colors)+
coord_flip()+
facet_grid(taxa~var_type,
scales = "free",
switch = "y",
space = "free_y") +
theme_light()
# plot
tmp_colors <- rev(c("#9b2226","#db912b","#005f73","#bb3e03","#ecba53","#0a9396","#94d2bd"))
tmp_df %>%
ggplot() +
aes(x= taxa, y= mean_pct, fill= var)+
geom_bar(stat = "identity", position = "stack")+
scale_fill_manual(values = tmp_colors)+
coord_flip()+
facet_grid(taxa~var_type,
scales = "free",
switch = "y",
space = "free_y") +
theme_bw()
tmp_df %>%
ggplot() +
aes(x= taxa, y= mean_pct, fill= var)+
geom_bar(stat = "identity", position = "stack")+
scale_fill_manual(values = tmp_colors)+
coord_flip()+
facet_grid(taxa~var_type,
scales = "free",
switch = "y",
space = "free_y") +
theme_classic()
# plot
tmp_colors <- c("#9b2226","#db912b","#005f73","#bb3e03","#ecba53","#0a9396","#94d2bd")
names(tmp_colors) <- c("a","b","d","a:b","a:d","b:d","a:b:d")
tmp_df %>%
ggplot() +
aes(x= taxa, y= mean_pct, fill= var)+
geom_bar(stat = "identity", position = "stack")+
scale_fill_manual(values = tmp_colors)+
coord_flip()+
facet_grid(taxa~var_type,
scales = "free",
switch = "y",
space = "free_y") +
theme_classic()
# how many sign_comp by var
tmp_df <- full_join(tmp_df1,tmp_df2,by = "OTU",relationship = "many-to-many") %>%
na.omit(.) %>%
# add taxo
left_join(.,taxtab[,c("OTU","taxa")],by="OTU") %>%
# summarise
dplyr::group_by(taxa,var) %>%
dplyr::summarise(mean_pct = mean(sgnf_pct_expl)) %>% ungroup()
# add missing taxa
tmp_missing_taxa <- expand.grid(setdiff(taxtab$taxa,tmp_df$taxa),unique(tmp_df$var)) %>%
rename(taxa = Var1, var = Var2) %>%
mutate(mean_pct = 0)
# add order and facet variable
tmp_df <- tmp_df %>%
rbind(tmp_missing_taxa) %>%
mutate(var_type = case_when(
var %in% c("a","b","d") ~ "main",
var %in% c("a:b","a:d","b:d") ~ "double",
var %in% c("a:b:d") ~ "triple"
)) %>%
mutate(
var = factor(var,levels = rev(c("a","b","d","a:b","a:d","b:d","a:b:d"))),
var_type = factor(var_type,levels = c("main","double","triple")),
taxa = factor(taxa,levels = (levels(reorder(taxtab$taxa,taxtab$order)))))
tmp_df %>%
ggplot() +
aes(x= taxa, y= mean_pct, fill= var)+
geom_bar(stat = "identity", position = "stack")+
scale_fill_manual(values = tmp_colors)+
coord_flip()+
facet_grid(taxa~var_type,
scales = "free",
switch = "y",
space = "free_y") +
theme_classic()
# which OTUs have signif fval
tmp_df2 <- stat_otu_aov_o %>%
filter(bonferroni <= 0.05) %>%
select(OTU,var,sgnf_pct_expl)
# how many sign_comp by var
tmp_df <- tmp_df2 %>%
na.omit(.) %>%
# add taxo
left_join(.,taxtab[,c("OTU","taxa")],by="OTU") %>%
# summarise
dplyr::group_by(taxa,var) %>%
dplyr::summarise(mean_pct = mean(sgnf_pct_expl)) %>% ungroup()
# add missing taxa
tmp_missing_taxa <- expand.grid(setdiff(taxtab$taxa,tmp_df$taxa),unique(tmp_df$var)) %>%
rename(taxa = Var1, var = Var2) %>%
mutate(mean_pct = 0)
# add order and facet variable
tmp_df <- tmp_df %>%
rbind(tmp_missing_taxa) %>%
mutate(var_type = case_when(
var %in% c("a","b","d") ~ "main",
var %in% c("a:b","a:d","b:d") ~ "double",
var %in% c("a:b:d") ~ "triple"
)) %>%
mutate(
var = factor(var,levels = rev(c("a","b","d","a:b","a:d","b:d","a:b:d"))),
var_type = factor(var_type,levels = c("main","double","triple")),
taxa = factor(taxa,levels = (levels(reorder(taxtab$taxa,taxtab$order)))))
# plot
tmp_colors <- c("#9b2226","#db912b","#005f73","#bb3e03","#ecba53","#0a9396","#94d2bd")
names(tmp_colors) <- c("a","b","d","a:b","a:d","b:d","a:b:d")
tmp_df %>%
ggplot() +
aes(x= taxa, y= mean_pct, fill= var)+
geom_bar(stat = "identity", position = "stack")+
scale_fill_manual(values = tmp_colors)+
coord_flip()+
facet_grid(taxa~var_type,
scales = "free",
switch = "y",
space = "free_y") +
theme_classic()
# which OTUs are affected by coal
tmp_df1 = stat_otu_emmeans_fltr %>%
filter(g1 == "C" & pval_adjust <= 0.05) %>%
mutate(
sign_comp = case_when(
# /!\ up = estimates <0
estimate <0 ~ "up",
estimate >0 ~ "down"
)
) %>%
select(OTU,sign_comp) %>%
unique(.)
# which OTUs have signif fval
tmp_df2 <- stat_otu_aov_o %>%
filter(bonferroni <= 0.05) %>%
select(OTU,var,sgnf_pct_expl)
# how many sign_comp by var
tmp_df <- full_join(tmp_df1,tmp_df2,by = "OTU",relationship = "many-to-many") %>%
na.omit(.)
# plot
tmp_colors <- rev(c("#9b2226","#db912b","#005f73","#bb3e03","#ecba53","#0a9396","#94d2bd"))
tmp_df %>%
# summarise: MEAN
dplyr::group_by(sign_comp,var) %>%
dplyr::summarise(mean_pct = mean(sgnf_pct_expl)) %>%
mutate(var_type = case_when(
var %in% c("a","b","d") ~ "main",
var %in% c("a:b","a:d","b:d") ~ "double",
var %in% c("a:b:d") ~ "triple"
)) %>%
mutate(
var = factor(var,levels = rev(c("a","b","d","a:b","a:d","b:d","a:b:d"))),
var_type = factor(var_type,levels = c("main","double","triple")),
sign_comp = factor(sign_comp,levels = c("up","down"))
) %>%
ggplot() +
aes(x= sign_comp, y= mean_pct, fill= var)+
geom_bar(stat = "identity", position = "stack")+
scale_fill_manual(values = tmp_colors)+
coord_flip()+
facet_grid(sign_comp~var_type,
scales = "free",
switch = "y",
space = "free_y") +
theme_classic()
# test diff for each var between up / down
# linear model
tmp_lm = lm(tmp_df$sgnf_pct_expl ~ tmp_df$var*tmp_df$sign_comp, na.action = na.omit )
summary(tmp_lm)
# anova
tmp_aov = aov(tmp_lm)
summary(tmp_aov)
# post hoc Tukey test
library(agricolae)
tmp_comp <- HSD.test(tmp_aov,c("tmp_df$var","tmp_df$sign_comp"),alpha = 0.05,group = T,console = T)
# tibble with statistical groups
tmp_stat = tibble("groups"=rownames(tmp_comp[["groups"]]),
"mean"=tmp_comp[["groups"]][["tmp_df$rel_fval"]],
"stat_groups"=as.character(tmp_comp[["groups"]][["groups"]]))
tmp_stat
# OR
tmp_emmeans = emmeans(tmp_lm,~c(var,sign_comp))
test(pairs(tmp_emmeans, by = "var"), by = NULL, adjust = "bonferroni") # see adjust method?
tmp_network_M0 = network_M0_edges %>%
mutate(
# add edge color & style
color = case_when(
value > 0 ~ "#3399FF",
.default = "#FF3366"),
style = "normal",
# edge absolute values
value = abs(value)
) %>%
select(source,target,value,color,style)
# extract data
write.table(tmp_network_M0,"itol/tmp_itol_connection.txt",quote = F,sep = ",",row.names = F)
tmp_network <- tmp_network_M0 %>%
# add taxa
rowwise() %>%
mutate(
link_taxa = paste(sort(c(taxtab$taxa[taxtab$OTU == source],
taxtab$taxa[taxtab$OTU == target])),collapse = " - "),
link_order = paste(sort(c(taxtab$Order[taxtab$OTU == source],
taxtab$Order[taxtab$OTU == target])),collapse = " - "),
link_family = paste(sort(c(taxtab$Family[taxtab$OTU == source],
taxtab$Family[taxtab$OTU == target])),collapse = " - "),
link_genus = paste(sort(c(taxtab$genus_clean[taxtab$OTU == source],
taxtab$genus_clean[taxtab$OTU == target])),collapse = " - ")
)
# plot by taxa ----
# geom bar = count number of links
tmp_network %>%
filter(link_taxa %in% c("Alphaproteobacteria - Firmicutes",
"Alphaproteobacteria - Gammaproteobacteria",
"Firmicutes - Gammaproteobacteria")) %>%
ggplot() +
aes(x = link_taxa, fill = color) +
geom_bar(position = "dodge") +
scale_fill_manual(values = c(`#3399FF` = "#3399FF",`#FF3366` = "#FF3366")
) +
labs(x = "Taxa", y = "Number of links") +
coord_flip() +
theme_minimal() +
theme(legend.position = 'none')
# plot by order ----
# geom bar = count number of links
tmp_network %>%
filter(link_taxa %in% c("Alphaproteobacteria - Firmicutes",
"Alphaproteobacteria - Gammaproteobacteria",
"Firmicutes - Gammaproteobacteria")) %>%
ggplot() +
aes(x = link_order, fill = color) +
geom_bar(position = "dodge") +
scale_fill_manual(values = c(`#3399FF` = "#3399FF",`#FF3366` = "#FF3366")
) +
labs(x = "Order", y = "Number of links") +
coord_flip() +
theme_minimal() +
facet_wrap(vars(link_taxa), scales = "free_y") +
theme(legend.position = 'none')
# plot by order ----
# geom bar = count number of links
tmp_network %>%
filter(link_taxa %in% c("Alphaproteobacteria - Firmicutes",
"Alphaproteobacteria - Gammaproteobacteria",
"Firmicutes - Gammaproteobacteria")) %>%
ggplot() +
aes(x = link_order, fill = color) +
geom_bar(position = "dodge") +
scale_fill_manual(values = c(`#3399FF` = "#3399FF",`#FF3366` = "#FF3366")
) +
labs(x = "Order", y = "Number of links") +
coord_flip() +
theme_minimal() +
facet_wrap(vars(link_taxa), scales = "free_y",ncol = 1) +
theme(legend.position = 'none')
